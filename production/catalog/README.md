# Gaia Catalog

This directory contains implementation of [catalog public interfaces](../inc/public/catalog/gaia_catalog.hpp).
Including `gaia_catalog.hpp` and linking `gaia_catalog` is the standard way to use the catalog library.
The implementation here may change without any notification.
If you are using the headers defined here directly, make sure you know what you are doing.

## Components

### Catalog manager
The sub-directory contains the following code.

- `catalog_manager` is a singleton class that implements all the catalog DDL APIs.
- `fbs_generator` implements FlatBuffers schema generation APIs.
- `gaia_generate` implements Gaia extended data classes (EDC) generation APIs.

### Parser
This is the scanner-parser for Gaia DDL.
We used a lex/parser generator, `flex/bison` specifically, to generate the C++ code.
The lexical analysis rules are defined in [`lexer.ll`](parser/src/lexer.ll).
The grammar rules are defined in [`parser.yy`](parser/src/parser.yy).
A helper or driver class `parser_t` of the lexer-parser is defined in [`gaia_parser.hpp`](parser/inc/gaia_parser.hpp).
Most parsing usage should call the `gaia::catalog::ddl:parser_t` instead of `yy_lex` or `yy_parser` interfaces.

### Gaiac
This is the catalog command line tool for Gaia data definition language.
It is used for bootstrapping the EDC definitions, manual testing and development.

Currently, when supplied with a file containing Gaia DDL, it will compile it into
the catalog tables, then automatically generate 3 additional files:
- The FlatBuffers schema, `<dbname>.fbs`
- The FlatBuffers header for field access, `<dbname>_generated.h`
- The EDC header file `gaia_<dbname>.h`

With the two headers, a direct access source file gains access to the database as
defined by the catalog.

`flatc` may be run using <dbname>.fbs with the following command-line arguments to get the same output of the C++ header(s).

```
flatc --cpp --gen-object-api \
  --cpp-str-type gaia::direct_access::nullable_string_t \
  --cpp-str-flex-ctor <dbname>.fbs
```

Usage:
```
   gaiac [-s] [-p] [-i] [-t] [ddl_file]
      where: -s ddl_file prints a parsing trace of ddl_file
             -p ddl_file prints a scanning trace of ddl_file
             -i          interactive prompt, as a REPL
             -o          PATH to all generated files
             -t          for testing, start the SE server
             ddl_file    process the DDL without tracing
```
Examples:
```
   gaiac -i
   gaiac airport.ddl
   gaiac -p airport.ddl
   gaiac -s airport.ddl
   gaiac       # generate gaia_catalog.h
```

## Bootstrapping the Catalog
The gaia catalog manager uses Extended Data Classes to perform operations on the catalog itself.
Compiling the catalog manager requires header files to define the EDC classes that are used.
This creates a bootstrapping issue where the original EDC definitions must be generated first.
The "code generation" functions require `gaia_catalog.h` and `catalog_generated.h` to exist before they can be compiled.

The current solution to this is to run the `gaiac` utility (which calls functions in the above mentioned functions) with no command-line parameters to generate the catalog strictly through the catalog manager API.
The catalog initialization invokes a function called `bootstrap_catalog()`.
To build `gaiac` the first time, a `gaia_catalog.h` was created by hand and `catalog_generated.h` was generated from handcraft fbs definition, sufficient for the code generating functions to operate.
The `gaia_catalog.h` and `catalog_generated.h` in source control are the ones that was generated by this bootstrapping method.

## Upgrading the Catalog
If the catalog schema is ever upgraded, it will be necessary to update `bootstrap_catalog()` method. After the bootstrap function is updated, `gaiac` can be built and run again without parameters to generate the new `gaia_catalog.h` and `catalog_generated.h`.
After this, gaia production should be rebuilt with the newly generated sources.

Be sure to update [system_table_types.hpp](../inc/internal/common/system_table_types.hpp) if new types are added or the `type_id` of the catalog tables change.

Be sure to save the new [gaia_catalog.h](../inc/internal/catalog/gaia_catalog.h) and [catalog_generated.h](../inc/internal/catalog/catalog_generated.h) in place of the previous ones.
