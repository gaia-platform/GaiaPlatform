# Gaia Catalog

## Components

`catalog_manager`
This is the catalog manager library.

`parser`
This is the parser library.

`gaiac`
This is an example catalog command line tool for Gaia data definition language.
It is used for bootstrapping the EDC definitions, manual testing and development.

Currently, when supplied with a file containing Gaia DDL, it will compile it into
the catalog tables, then automatically generate 3 additional files:
- The flatbuffer schema, `<dbname>.fbs`
- The flatbuffer header for field access, `<dbname>_generated.h`
- The EDC header file `gaia_<dbname>.h`

With the two headers, a direct access source file gains access to the database as
defined by the catalog.

If the `flatc` compiler fails to run during the execution of `gaiac`, the <dbname>_generated.h
file will not be created. To fix this, be sure `flatc` is in PATH and run `gaiac` again.

Alternatively, `flatc` may be run using <dbname>.fbs with the following command-line
arguments:

```
flatc --cpp --gen-object-api \
  --cpp-str-type gaia::direct_access::nullable_string_t \
  --cpp-str-flex-ctor <dbname>.fbs
```

Usage:
```
   gaiac [-s] [-p] [-i] [-t] [ddl_file]
      where: -s ddl_file prints a parsing trace of ddl_file
             -p ddl_file prints a scanning trace of ddl_file
             -i          interactive prompt, as a REPL
             -o          PATH to all generated files
             -t          for testing, start the SE server
             ddl_file    process the DDL without tracing
```
Examples:
```
   gaiac -i
   gaiac airport.ddl
   gaiac -p airport.ddl
   gaiac -s airport.ddl
   gaiac       # generate gaia_catalog.h
```
## Bootstrapping the Catalog
The gaia catalog manager uses Extended Data Classes to perform operations on the catalog itself. Compiling the catalog manager requires header files to define the EDC classes that are used. This creates a bootstrapping issue where the original EDC definitions must be generated first. Two "code generation" functions require "#include gaia_catalog.h" to exist before they can be compiled.

The current solution to this is to run the `gaiac` utility (which calls functions in the above mentioned functions) with no command-line parameters to generate the catalog strictly through the catalog manager API. This invokes a function called `load_bootstrap_catalog()`. To build `gaiac` the first time, a `gaia_catalog.h` was created by hand, sufficient for the code generating functions to operate. But the stored `gaia_catalog.h` is the one that was generated by this bootstrapping method.

## Upgrading the Catalog
If the catalog schema is ever upgraded, it will be necessary to update `catalog.ddl` and `load_bootstrap_catalog()` simultaneously. After the bootstrap function is updated, `gaiac` can be built and run again without parameters to generate the new `gaia_catalog.h` file. After this, `gaiac` should be rebuilt so that it can compile `catalog.ddl`. This will cause a new flatbuffer header to be generated that should be compiled into the catalog manager.  

Be sure to update [system_catalog_types.hpp](../inc/internal/common/system_catalog_types.hpp) if new types are added or the type_id of the catalog tables change.

Be sure to save the new `gaia_catalog.h` in place of the previous one.
