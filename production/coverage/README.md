# Gaia Production Code Coverage

This directory contains the scripts necessary to generate the code coverage statistics for the platform.
There are two main outputs for this process:

1. A `coverage.json` file in the `coverage/output` directory that contains a quick summary, broken down by team/group.
2. A group of directories under the `coverage/output` directory, with an `index.html` file in each one.  These directories are generated by the coverage process and give detailed information on what is covered and how.

A `coverage/output/coverage.zip` file contains the entire contents of the `output` directory, suitable for quick posting or attaching to messages.

## The Process

This process is kicked off by executing the `coverage.sh` in the `production/coverage` directory.
The script then takes care of setting the requirements up to create a GDEV docker image based on the contents of the production directory.
While most of the requirements can be hosted in the `coverage` directory, the `gdev.cfg` file must exist in the root production directory.
As such, care during setup is taken to create a backup of this file, copy the coverage version of this file over that file, and once the analysis is done, restoring that file from the backup.

Once all requirements are in place, the execution of the workflow starts.
The first step of this workflow is to create a GDEV docker container that can be used for the analysis.
This is a container complete with the source code (`/source/production`) and the build artifacts (`/build/production`) generated from the files that are present in the source tree where this command is kicked off from.
If the container was built recently, the building of the container may be skipped or may only take roughly 5 minutes to create.
If this is the first time the container is being built, then this process may take up to 30 minutes to complete.
Note that this lengthy process is required as the coverage workflow requires compiling and linking with specific flags.

Once the docker image has been created, the `gen_coverage.sh` script is executed inside of the container.
This script grabs the latest version of the `lcov` package and installs it.
Along with some support files from the `coverage` directory, the script then uses the `lcov` tool to provide an "empty" snapshot of the compiled code.
After the tests are executed (see the following section), another snapshot is taken.
This snapshot is then taken and filtered to remove any test code or known "false" areas of production code.
This `total` snapshot contains every measured bit of coverage in the entire project.
This snapshot is then filtered more to produce the `rules`, `database`, and `other` reports.
Finally, the `raw` report is generated to provide for a double check of the base level of coverage that was reported on.
Basically, if it did not make it into the `raw` report, it will not show up in the other reports.

Once this is completed, the `coverage.json` file is generated and the `coverage.zip` file is generated before exitting the main script.

## What Tests Are Covered?

To be covered, the current setup requires that the test is included when the `ctest` program is executed from the root of the production directory.
