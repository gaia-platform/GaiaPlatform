#############################################
# Copyright (c) Gaia Platform LLC
# All rights reserved.
#############################################

project(sdk)

set(TEMP_PACKAGE_FOLDER "${CMAKE_CURRENT_BINARY_DIR}/tmp")
set(PGSQL_PACKAGE_FOLDER "${TEMP_PACKAGE_FOLDER}/opt/gaia/lib/pgsql_ext")
set(GAIA_PACKAGE_VERSION "0.1.0")
set(GAIA_DEB_PACKAGE_NAME "gaia_${GAIA_PACKAGE_VERSION}_amd64.deb")
set(GAIA_LIBRARY_NAME "libgaia.so.${GAIA_PACKAGE_VERSION}")

include(gaia)

file(WRITE ${CMAKE_BINARY_DIR}/sdk_dummy.c "")

add_library(gaia SHARED ${CMAKE_BINARY_DIR}/sdk_dummy.c)
set(SDK_LINK_LIBRARIES
  -Wl,--whole-archive
  gaia_system
  -Wl,--no-whole-archive
)

target_link_libraries(gaia PRIVATE
  ${SDK_LINK_LIBRARIES}
)

if(BUILD_GAIA_RELEASE)
  if (TARGET gaia_fdw)
    add_custom_command(
      OUTPUT ${PGSQL_PACKAGE_FOLDER}
      COMMAND cmake -E copy_if_different $<TARGET_SONAME_FILE:gaia_fdw> ${PGSQL_PACKAGE_FOLDER}/$<TARGET_SONAME_FILE_NAME:gaia_fdw>
      COMMAND cmake -E copy_directory ${GAIA_PROD_BUILD}/sql/pgsql ${PGSQL_PACKAGE_FOLDER}
      DEPENDS gaia_fdw
    )
  else()
    add_custom_command(
      OUTPUT ${PGSQL_PACKAGE_FOLDER}
      COMMAND cmake -E make_directory ${PGSQL_PACKAGE_FOLDER}
    )
  endif()

  add_custom_command(
    OUTPUT  ${CMAKE_CURRENT_BINARY_DIR}/${GAIA_DEB_PACKAGE_NAME}
    OUTPUT  ${CMAKE_CURRENT_BINARY_DIR}/gaia.rpm

    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/control ${TEMP_PACKAGE_FOLDER}/DEBIAN/control
    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/changelog ${TEMP_PACKAGE_FOLDER}/DEBIAN/changelog
    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/copyright ${TEMP_PACKAGE_FOLDER}/DEBIAN/copyright
    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/preinst ${TEMP_PACKAGE_FOLDER}/DEBIAN/preinst
    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/postinst ${TEMP_PACKAGE_FOLDER}/DEBIAN/postinst

    COMMAND cmake -E copy_directory ${GAIA_INC}/gaia ${TEMP_PACKAGE_FOLDER}/opt/gaia/include/gaia
    COMMAND cmake -E copy_if_different ${FLATBUFFERS_INC}/flatbuffers/flatbuffers.h ${TEMP_PACKAGE_FOLDER}/opt/gaia/include/flatbuffers/flatbuffers.h
    COMMAND cmake -E copy_if_different ${FLATBUFFERS_INC}/flatbuffers/base.h ${TEMP_PACKAGE_FOLDER}/opt/gaia/include/flatbuffers/base.h
    COMMAND cmake -E copy_if_different ${FLATBUFFERS_INC}/flatbuffers/stl_emulation.h ${TEMP_PACKAGE_FOLDER}/opt/gaia/include/flatbuffers/stl_emulation.h

    COMMAND cmake -E copy_if_different ${GAIA_PROD_BUILD}/db/storage_engine/gaia_se_server ${TEMP_PACKAGE_FOLDER}/opt/gaia/bin/gaia_se_server
    COMMAND cmake -E copy_if_different ${GAIA_PROD_BUILD}/catalog/gaiac/gaiac ${TEMP_PACKAGE_FOLDER}/opt/gaia/bin/gaiac
    COMMAND cmake -E copy_if_different ${GAIA_PROD_BUILD}/tools/gaia_translate/gaiat ${TEMP_PACKAGE_FOLDER}/opt/gaia/bin/gaiat

    COMMAND cmake -E copy_if_different ${GAIA_PROD_BUILD}/rocksdb/librocksdb.so ${TEMP_PACKAGE_FOLDER}/opt/gaia/lib/librocksdb.so.6
    COMMAND cmake -E copy_if_different ${CMAKE_CURRENT_BINARY_DIR}/libgaia.so ${TEMP_PACKAGE_FOLDER}/opt/gaia/lib/${GAIA_LIBRARY_NAME}

    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/gaia.conf ${TEMP_PACKAGE_FOLDER}/etc/opt/gaia/gaia.conf
    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/gaia_log.conf ${TEMP_PACKAGE_FOLDER}/etc/opt/gaia/gaia_log.conf

    COMMAND cmake -E copy_if_different ${GAIA_REPO}/demos/incubator/demo_script.md ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/demo_script.md
    COMMAND cmake -E copy_if_different ${GAIA_REPO}/demos/incubator/gaia.conf ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/gaia.conf
    COMMAND cmake -E copy_if_different ${GAIA_REPO}/demos/incubator/gaia_log.conf ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/gaia_log.conf
    COMMAND cmake -E copy_if_different ${GAIA_REPO}/demos/incubator/incubator.ddl ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/incubator.ddl
    COMMAND cmake -E copy_if_different ${GAIA_REPO}/demos/incubator/incubator.ruleset ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/incubator.ruleset
    COMMAND cmake -E copy_if_different ${GAIA_REPO}/demos/incubator/main.cpp ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/main.cpp
    COMMAND cmake -E copy_if_different ${GAIA_REPO}/demos/incubator/README.md ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/README.md
    COMMAND cmake -E copy_if_different ${PROJECT_SOURCE_DIR}/CMakeLists-incubator.txt ${TEMP_PACKAGE_FOLDER}/opt/gaia/examples/incubator_demo/CMakeLists.txt

    COMMAND dpkg-deb --build ${TEMP_PACKAGE_FOLDER} ${CMAKE_CURRENT_BINARY_DIR}/${GAIA_DEB_PACKAGE_NAME}

    COMMAND cmake -E rm -r ${TEMP_PACKAGE_FOLDER}/DEBIAN

    COMMAND rpmbuild --bb ${PROJECT_SOURCE_DIR}/gaia.spec --define "_rpmdir ${CMAKE_CURRENT_BINARY_DIR}" --define "buildroot ${TEMP_PACKAGE_FOLDER}" --define "_build_name_fmt gaia.rpm"

    COMMAND cmake -E rm -r ${TEMP_PACKAGE_FOLDER}

    DEPENDS gaiac
    DEPENDS gaiat
    DEPENDS gaia_se_server
    DEPENDS gaia_system
    DEPENDS ${PROJECT_SOURCE_DIR}/control
    DEPENDS ${PROJECT_SOURCE_DIR}/preinst
    DEPENDS ${PROJECT_SOURCE_DIR}/postinst
    DEPENDS ${PROJECT_SOURCE_DIR}/changelog
    DEPENDS ${PROJECT_SOURCE_DIR}/copyright
    DEPENDS ${PROJECT_SOURCE_DIR}/gaia.spec
    DEPENDS ${PGSQL_PACKAGE_FOLDER}
    COMMENT "Compiled SDK packages."
  )

  add_custom_target(generate_gaia_deb_package ALL
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/${GAIA_DEB_PACKAGE_NAME}
    DEPENDS ${CMAKE_CURRENT_BINARY_DIR}/gaia.rpm
  )
endif()

#
# Ensure this test only includes public headers and links to the gaia shared library.
#
set(SDK_TEST_INCLUDES
  ${GAIA_INC}
  ${FLATBUFFERS_INC}
  ${GAIA_GENERATED_SCHEMAS}
)

configure_file("${GAIA_CONFIG}" "${PROJECT_BINARY_DIR}/gaia.conf")
configure_file("${GAIA_LOG_CONFIG}" "${PROJECT_BINARY_DIR}/gaia_log.conf")
add_gtest(test_sdk "tests/test_sdk.cpp" "${SDK_TEST_INCLUDES}" "rt;gaia" "generate_addr_book_headers")
