[apt]
build-essential
clang-8
git
python3

[gaia]
production
third_party/production/cmake

[pre_run]
--mount=type=ssh \
mkdir -p -m 0600 ~/.ssh
ssh-keyscan github.com >> ~/.ssh/known_hosts
git clone git@github.com:gaia-platform/TranslationEngineLLVM.git
cd TranslationEngineLLVM
git checkout 99ef5a0d42e2198318c7ca353098145093f8a41c
rm -rf .git
rm -rf ~/.ssh
rm -rf /usr/lib/gcc/x86_64-linux-gnu/10

[run]
cmake -DLLVM_ENABLE_EH=ON \
    -DCMAKE_BUILD_TYPE=Release \
    -DLLVM_ENABLE_PROJECTS=clang \
    -DLLVM_ENABLE_RTTI=ON \
    -DGAIA_SOURCE={source_dir('')} \
    -DGAIA_PROD_BUILD={build_dir('production')} \
    -G "Unix Makefiles" \
    TranslationEngineLLVM/llvm
make -j$(nproc)
